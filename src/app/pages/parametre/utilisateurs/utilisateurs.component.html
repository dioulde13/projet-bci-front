<div class="page-content">
  <div class="container-fluid py-4">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1 class="text-primary mb-1 h4">
              <i class="fas fa-building me-2"></i> Liste des Utilisateurs
            </h1>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" (click)="openCreateModal()">
              <i class="fas fa-plus me-1"></i>
              Créer un nouveau utilisateur
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="table-responsive">
          <div class="d-flex justify-content-between mb-2">
            <button class="btn btn-success" (click)="exportExcel()">
              Exporter Excel
            </button>
            <input
              type="text"
              class="form-control w-25"
              placeholder="Rechercher..."
              [(ngModel)]="searchText"
              (input)="currentPage = 1"
            />
          </div>
          <table
            *ngIf="!isLoadingUser && allUsers.length > 0"
            class="table table-hover table-striped mb-0 datatable"
          >
            <thead class="table-primary">
              <tr>
                <th>#</th>
                <th (click)="sort('vcFirstname')">Prénom</th>
                <th (click)="sort('vcLastname')">Nom</th>
                <th (click)="sort('email')">Email</th>
                <th (click)="sort('vcPhoneNumber')">Téléphone</th>
                <th (click)="sort('vcRoleName')">Rôle</th>
                <th (click)="sort('dtCreated')">Date Création</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let user of pagedBeneficiaire; let i = index">
                <td>{{ i + 1 }}</td>

                <td>{{ user.vcFirstname }}</td>
                <td>{{ user.vcLastname }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.vcPhoneNumber }}</td>
                <td>{{ user.vcRoleName }}</td>

                <td>{{ user.dtCreated | date : "dd/MM/yyyy" }}</td>

                <td>
                  <div class="d-flex gap-1 justify-content-center">
                    <button
                      type="button"
                      class="btn btn-action btn-sm"
                      (click)="onToggle(user)"
                      [title]="user.btEnabled ? 'Désactiver' : 'Réactiver'"
                    >
                      <i
                        class="fas"
                        [ngClass]="{
                          'fa-lock-open text-success': user.btEnabled,
                          'fa-lock text-danger': !user.btEnabled
                        }"
                      ></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Pagination -->
          <div class="d-flex justify-content-between align-items-center mt-2">
            <div>
              Affichage {{ startIndex() }} à {{ endIndex() }} sur
              {{ filteredData.length }} éléments
            </div>
            <div>
              <button
                class="btn btn-sm btn-outline-secondary me-1"
                (click)="previousPage()"
                [disabled]="currentPage === 1"
              >
                Précédent
              </button>

              <button
                *ngFor="let page of getPages()"
                class="btn btn-sm me-1"
                [ngClass]="{
                  'btn-outline-secondary':
                    page !== currentPage && page !== '...',
                  'btn-secondary': page === currentPage,
                  disabled: page === '...'
                }"
                (click)="onPageClick(page)"
              >
                {{ page }}
              </button>

              <button
                class="btn btn-sm btn-outline-secondary"
                (click)="nextPage()"
                [disabled]="currentPage === totalPages()"
              >
                Suivant
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="isLoadingUser" class="text-center my-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">
              Chargement des données en cours...
            </span>
          </div>
          <p class="text-muted">
            Veuillez patienter pendant que les données se chargent.
          </p>
        </div>

        <div
          *ngIf="!isLoadingUser && allUsers.length === 0"
          class="text-center mt-3"
        >
          <p>Aucun utilisateur trouvé.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" role="dialog" tabindex="-1" id="createUserModal">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-white bg-primary">
        <h5 class="text-white modal-title">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="1em"
            height="1em"
            viewBox="0 0 20 20"
            fill="none"
          >
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18ZM11 7C11 6.44772 10.5523 6 10 6C9.44772 6 9 6.44772 9 7V9H7C6.44772 9 6 9.44771 6 10C6 10.5523 6.44772 11 7 11H9V13C9 13.5523 9.44772 14 10 14C10.5523 14 11 13.5523 11 13V11H13C13.5523 11 14 10.5523 14 10C14 9.44772 13.5523 9 13 9H11V7Z"
              fill="currentColor"
            ></path>
          </svg>
          Créer un nouveau utilisateur
        </h5>
        <button
          class="btn-close btn-close-white"
          aria-label="Close"
          data-bs-dismiss="modal"
          type="button"
        ></button>
      </div>

      <div class="modal-body">
        <form [formGroup]="userForm" autocomplete="off">
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label" for="role">
                  Rôle <span class="text-danger">*</span>
                </label>
                <select
                  class="form-select form-select"
                  required
                  id="role"
                  formControlName="iRoleID"
                  [ngClass]="getFormControlClass('iRoleID')"
                >
                  <option [value]="null">--Sélectionnez un rôle--</option>
                  <option *ngFor="let r of roles" [value]="r.id">
                    {{ r.vcRoleName }}
                  </option>
                </select>

                <span class="text-danger" *ngIf="isInvalid('iRoleID')">
                  {{ getErrorMessage("iRoleID") }}
                </span>
              </div>
            </div>

            <div class="col-md-4">
              <div class="mb-3">
                <label for="firstname" class="form-label">
                  Prénom <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  id="firstname"
                  class="form-control"
                  required
                  formControlName="vcFirstname"
                  [ngClass]="getFormControlClass('vcFirstname')"
                />
                <span class="text-danger" *ngIf="isInvalid('vcFirstname')">
                  {{ getErrorMessage("vcFirstname") }}
                </span>
              </div>
            </div>

            <div class="col-md-4">
              <div class="mb-3">
                <label for="lastname" class="form-label">
                  Nom <span class="text-danger">*</span>
                </label>
                <input
                  type="text"
                  id="lastname"
                  class="form-control"
                  required
                  formControlName="vcLastname"
                  [ngClass]="getFormControlClass('vcLastname')"
                />
                <span class="text-danger" *ngIf="isInvalid('vcLastname')">
                  {{ getErrorMessage("vcLastname") }}
                </span>
              </div>
            </div>

            <div class="col-md-4">
              <div class="mb-3">
                <label for="email" class="form-label">
                  Email <span class="text-danger">*</span>
                </label>
                <input
                  type="email"
                  id="email"
                  class="form-control"
                  required
                  formControlName="vcEmail"
                  [ngClass]="getFormControlClass('vcEmail')"
                />
                <span class="text-danger" *ngIf="isInvalid('vcEmail')">
                  {{ getErrorMessage("vcEmail") }}
                </span>
              </div>
            </div>

            <div class="col-md-4">
              <label>
                Téléphone
                <span class="text-danger">*
                   <!-- ({{ phoneMaxLength }} carractères obligatoire) -->

                </span>
              </label>

              <div class="input-group mb-3">
                <span class="input-group-text" id="basic-addon1">
                  +{{ phoneCode }}
                </span>

                <input
                  type="text"
                  placeholder="Entrez votre téléphone"
                  formControlName="vcPhoneNumber"
                  class="form-control form-control"
                  (keydown)="onlyDigits($event)"
                  (paste)="onPaste($event)"
                  [ngClass]="getFormControlClass('vcPhoneNumber')"
                />
              </div>
              <span class="text-danger" *ngIf="isInvalid('vcPhoneNumber')">
                {{ getErrorMessage("vcPhoneNumber") }}
              </span>
            </div>

            <div class="col-md-4">
              <label class="form-label">
                Pays<span class="text-danger">*</span>
              </label>
              <select
                class="form-select form-select"
                required
                formControlName="idPays"
                [ngClass]="getFormControlClass('idPays')"
              >
                <option [value]="null">-- Sélectionnez un pays --</option>
                <option *ngFor="let country of listePays" [value]="country.id">
                  {{ country.vcName }}
                </option>
              </select>

              <span class="text-danger" *ngIf="isInvalid('idPays')">
                {{ getErrorMessage("idPays") }}
              </span>
            </div>

            <div class="col-md-4">
              <label class="form-label">
                Mode d'envoi de l'OTP <span class="text-danger">*</span>
              </label>

              <div
                class="form-check"
                [ngClass]="getFormControlClass('modeOtp')"
              >
                <input
                  class="form-check-input"
                  type="radio"
                  formControlName="modeOtp"
                  id="otp_sms"
                  value="SMS"
                />
                <label class="form-check-label" for="otp_sms"> SMS </label>
              </div>

              <div class="form-check">
                <input
                  class="form-check-input"
                  type="radio"
                  formControlName="modeOtp"
                  id="otp_email"
                  value="Email"
                />
                <label class="form-check-label" for="otp_email"> Email </label>
              </div>

              <span class="text-danger" *ngIf="isInvalid('modeOtp')">
                {{ getErrorMessage("modeOtp") }}
              </span>
            </div>

            <div class="col-md-12">
              <div class="mb-3">
                <label class="form-label" for="description">
                  Description <span class="text-danger">*</span>
                </label>
                <textarea
                  class="form-control"
                  required
                  rows="3"
                  name="description"
                  formControlName="vcDescription"
                  [ngClass]="getFormControlClass('vcDescription')"
                ></textarea>

                <span class="text-danger" *ngIf="isInvalid('vcDescription')">
                  {{ getErrorMessage("vcDescription") }}
                </span>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" data-bs-dismiss="modal" type="button">
          Annuler
        </button>

        <button class="btn btn-primary" type="button" (click)="onSubmit()">
          <span *ngIf="!isLoading">Enregistrer</span>
          <span *ngIf="isLoading">
            <span
              class="spinner-border spinner-border-sm"
              role="status"
              aria-hidden="true"
            ></span>
            Enregistrement en cours...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="bloquerDebloquerModal"
  tabindex="-1"
  aria-labelledby="bloquerDebloquerLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bloquerDebloquerLabel">Confirmation</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Fermer"
        ></button>
      </div>

      <div class="modal-body text-center">
        <p>
          Êtes-vous sûr de vouloir
          <strong
            [ngClass]="{
              'text-danger': btEnabled === 0,
              'text-primary': btEnabled === 1
            }"
          >
            {{ btEnabled === 0 ? "bloquer" : "activer" }}
          </strong>
          cet utilisateur ?
        </p>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
          [disabled]="isloadingBloquerDebloquer"
        >
          Non
        </button>

        <button
          type="button"
          class="btn btn-primary"
          (click)="bloquerEtDebloquer()"
          [disabled]="isloadingBloquerDebloquer"
        >
          <ng-container
            *ngIf="!isloadingBloquerDebloquer; else loadingTemplate"
          >
            Oui
          </ng-container>
          <ng-template #loadingTemplate>
            <span
              class="spinner-border spinner-border-sm me-1"
              role="status"
              aria-hidden="true"
            ></span>
            En cours...
          </ng-template>
        </button>
      </div>
    </div>
  </div>
</div>
